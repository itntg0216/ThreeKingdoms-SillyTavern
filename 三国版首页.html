<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>汉末风云·万途归尘</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;500;700&display=swap');

        .recheck-container {
            text-align: center;
            margin: 25px 0 10px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .recheck-button {
            font-family: var(--body-font);
            font-weight: 500;
            font-size: 1em;
            color: var(--title-color);
            background-color: var(--item-bg-color);
            border: 1px solid var(--border-color);
            padding: 8px 25px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .recheck-button:hover {
            background-color: var(--item-bg-hover-color);
            border-color: var(--border-strong-color);
        }

        .clear-cache-button {
            font-family: var(--body-font);
            font-weight: 500;
            font-size: 1em;
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 8px 25px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .clear-cache-button:hover {
            background-color: #f1b0b7;
            border-color: #dc3545;
        }

        .env-check-container {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: rgba(253, 250, 245, 0.9);
            padding: 10px 20px;
            margin: 25px 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .env-check-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .env-check-item:not(:last-child) {
            border-bottom: 1px dashed var(--border-color);
        }

        .env-check-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: var(--title-color);
        }

        .env-check-label .icon {
            font-size: 1.4em;
            margin-right: 12px;
            opacity: 0.8;
            line-height: 1;
        }

        .env-check-details {
            display: flex;
            align-items: center;
            font-size: 0.9em;
            gap: 15px;
            text-align: right;
        }

        .env-check-details strong {
            font-weight: 700;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            min-width: 55px;
            text-align: center;
            border: 1px solid transparent;
        }

        .status-ok {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status-warn {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .status-unknown {
            background-color: #e2e3e5;
            color: #383d41;
            border-color: #d6d8db;
        }

        .locked-module {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
            user-select: none;
            transition: all 0.3s ease;
        }

        :root {
            --bg-color: #f5efe6;
            --text-color: #4a3b31;
            --border-color: #d3c5b3;
            --border-strong-color: #785a4e;
            --title-color: #5d4037;
            --link-color: #8c6d62;
            --item-bg-color: rgba(253, 250, 245, 0.9);
            --item-bg-hover-color: #e8ddcb;
            --item-bg-selected-color: #d7c8b6;
            --pre-bg-color: rgba(215, 200, 182, 0.3);
            --container-bg-color: rgba(240, 230, 210, 0.9);
            --title-font: 'Cinzel', serif;
            --body-font: 'Noto Serif SC', serif;
        }

        body {
            font-family: var(--body-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-image: url('data:image/png;base64,iVBORw0KUAhEUgAAADIAAAAyCAMAAAAp4XiGAAAAA3NCSVQICAjb4U/gAAAACXBIWXMAAADdAAAA3QFwU6IHAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAABbUExURQAAAP////f3+Pj4+fX19vb2+PT09Pj4+d/f4O/v8fPz9PX19vf3+Pn5+fb29/Hx8/T09fX19fX19////97e4Ojo6fHx8/Ly8/X19fX19fDw8vX19e/v8fj4+Pf3+AAAADSAx5YAAAAfdFJOUwAAAAAAAAAAAAAAAMA/z/BAgMBAwBCgwFBPT1BQUD9/Py8vRkQoCgAAAQBJREFUSMftlVuSgyAQhUNtZRAScQExPff9H3CBQsEMZDDpOf2EM8P9NZnZzI5KEfEPMGOIsIApFgAAFDtAAmWiIAMAWGDVQDQAAkYMm9RhpJbrBLhZ1Z6yGvWq2xWA92i6ZXRtC50EAADg0n8ErvDY2esxAEBW96Fz0Npq7H0AGBzh6MrAgAAgAEEyNiyL00mDgCsvt9jX6gAEEPg2pS8HAABgB2b0ONnuaR4AQDG9OQCAfQD8XRsBACJmk/+1WwUALg7A8IUBjgh0JGBgAJY2YB+S/VB9aKjpx5EDP5HAPk7Jm4tJgLeJ3I0LANT3/k7K/r5Q/AAAFYxxfYq1LAAAAABJRU5ErkJggg==');
            background-repeat: repeat;
        }

        .selector-scroll {
            border: 2px solid var(--border-strong-color);
            border-radius: 8px;
            padding: 25px;
            background-color: var(--container-bg-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .step-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .step-content.hidden {
            display: none;
        }

        .step-content.fade-out {
            opacity: 0;
            transform: translateY(-10px);
        }

        .step-content.fade-in-start {
            opacity: 0;
            transform: translateY(10px);
        }

        .step-footer {
            text-align: center;
            margin-top: auto;
            padding-top: 20px;
        }

        .page-super-title {
            font-family: var(--title-font);
            font-weight: 700;
            text-align: center;
            font-size: 2.8em;
            color: var(--title-color);
            margin: 10px 0 0 0;
            letter-spacing: 2px;
        }

        .ornamental-divider {
            border: 0;
            height: 1px;
            background-color: var(--border-color);
            position: relative;
            margin: 25px auto 30px auto;
            width: 85%;
        }

        .ornamental-divider::after {
            content: '❖';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--container-bg-color);
            padding: 0 15px;
            color: var(--title-color);
            font-size: 1.6em;
            line-height: 1;
        }

        .info-panel {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            background-color: var(--item-bg-color);
        }

        .info-panel > summary {
            font-family: var(--title-font);
            font-weight: 700;
            font-size: 1.1em;
            color: var(--title-color);
            background-color: var(--item-bg-selected-color);
            padding: 12px 20px;
            cursor: pointer;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .info-panel > summary::-webkit-details-marker {
            display: none;
        }

        .info-panel > summary:hover {
            background-color: #c9bba9;
        }

        .arrow-toggle {
            font-size: 0.8em;
            transition: transform 0.3s ease-out;
            display: inline-block;
        }

        .info-panel[open] > summary .arrow-toggle {
            transform: rotate(-90deg);
        }

        .info-content {
            padding: 15px 25px 25px 25px;
            line-height: 1.7;
        }

        .info-content h3 {
            font-family: var(--title-font);
            color: var(--title-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin: 25px 0 15px 0;
            font-size: 1.4em;
        }

        .info-content h3:first-child {
            margin-top: 5px;
        }

        .info-content p,
        .info-content ul {
            margin: 0 0 1em 0;
        }

        .info-content ul {
            list-style: none;
            padding-left: 5px;
        }

        .info-content li {
            padding-left: 20px;
            position: relative;
        }

        .info-content li::before {
            content: '»';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--border-strong-color);
            font-weight: bold;
        }

        .info-content a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 500;
            word-break: break-all;
        }

        .info-content a:hover {
            text-decoration: underline;
            color: var(--title-color);
        }

        .prerequisites {
            background-color: var(--pre-bg-color);
            border: 1px dashed var(--border-color);
            padding: 15px 20px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .prerequisites h4 {
            font-family: var(--body-font);
            font-weight: 700;
            color: var(--title-color);
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .prerequisites ul {
            margin-bottom: 0;
        }

        .main-title {
            font-family: var(--title-font);
            font-weight: 700;
            color: var(--title-color);
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 2.2em;
        }

        .instructions {
            text-align: center;
            margin-bottom: 25px;
            font-size: 0.95em;
            color: #6a514d;
        }

        .scenario-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .scenario-option {
            font: inherit;
            color: inherit;
            background: var(--item-bg-color);
            border: 1px solid var(--border-color);
            text-align: left;
            width: 100%;
            padding: 12px 15px 12px 40px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
            font-size: 1.05em;
        }

        .scenario-option::before {
            content: '📜';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1em;
            opacity: 0.7;
            transition: all 0.2s ease-in-out;
        }

        .scenario-option:hover {
            background-color: var(--item-bg-hover-color);
            border-color: var(--border-strong-color);
            transform: translateX(5px);
        }

        .scenario-option:hover::before {
            opacity: 1;
            transform: translateY(-50%) rotate(-5deg);
        }

        .scenario-option.selected {
            background-color: var(--item-bg-selected-color);
            border-color: var(--title-color);
            color: var(--title-color);
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .scenario-option.selected::after {
            content: '✓';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: var(--title-color);
        }

        .control-panel-container {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: rgba(253, 250, 245, 0.9);
            padding: 15px 20px;
            margin: 25px 0;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 5px;
        }

        .control-group-title {
            font-weight: 500;
            color: var(--title-color);
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
            font-size: 1.1em;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-item-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1 0 140px;
            max-width: 280px;
        }

        .control-button {
            font-family: var(--body-font);
            font-size: 0.95em;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: var(--item-bg-color);
            color: var(--text-color);
            opacity: 0.8;
            width: 100%;
        }

        .button-desc {
            font-size: 0.8em;
            color: #6a514d;
            margin-top: 6px;
            text-align: center;
            opacity: 0.8;
            line-height: 1.3;
            min-height: 1em;
        }

        .control-button:hover {
            background-color: var(--item-bg-hover-color);
            border-color: var(--border-strong-color);
            opacity: 1;
        }

        .control-button.disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #e0e0e0;
        }

        .control-button.selected {
            background-color: var(--item-bg-selected-color);
            border-color: var(--title-color);
            color: var(--title-color);
            font-weight: 500;
            opacity: 1;
        }

        .control-button.toggled-on {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
            font-weight: 500;
            opacity: 1;
        }

        .control-button.toggled-on:hover {
            background-color: #c3e6cb;
        }

        #lorebook-status {
            font-size: 0.9em;
            text-align: center;
            color: #856404;
            margin-top: -15px;
            margin-bottom: 20px;
        }

        .credits-container {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background-color: rgba(253, 250, 245, 0.6);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
        }

        .credits-title {
            font-family: var(--title-font);
            font-weight: 700;
            color: var(--title-color);
            margin-bottom: 15px;
            font-size: 1.2em;
            letter-spacing: 1px;
        }

        .author-badges {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .author-badge {
            background-color: var(--item-bg-color);
            border: 1px solid var(--border-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            color: var(--text-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: default;
        }

        .author-badge:hover {
            transform: translateY(-2px);
            border-color: var(--border-strong-color);
            background-color: var(--item-bg-hover-color);
        }

        .credits-special {
            font-size: 0.95em;
            color: #6a514d;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dotted var(--border-color);
            display: inline-block;
            padding-left: 20px;
            padding-right: 20px;
        }

        .world-quote {
            background-color: rgba(245, 239, 230, 0.5);
            border-left: 3px solid var(--border-strong-color);
            padding: 12px 18px;
            margin: 15px 0;
            font-style: italic;
            color: #5d4037;
            font-family: 'KaiTi', 'STKaiti', '楷体', var(--body-font);
            line-height: 1.6;
        }

        .update-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }

        @media screen and (max-width: 600px) {
            body {
                padding: 10px;
            }

            .selector-scroll {
                padding: 15px;
            }

            .page-super-title {
                font-size: 2em;
            }

            .main-title {
                font-size: 1.8em;
            }

            .scenario-option {
                padding: 10px 15px 10px 35px;
                font-size: 1em;
            }

            .info-panel > summary {
                padding: 10px 15px;
            }

            .info-content {
                padding: 15px;
            }

            .control-item-wrapper {
                flex-basis: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="selector-scroll">
        <h1 class="page-super-title">汉末风云·万途归尘</h1>
        <hr class="ornamental-divider" />

        <div class="credits-container">
            <div class="credits-title">❖ 制作团队 ❖</div>
            <div class="author-badges">
                <span class="author-badge">@𝕽𝖍𝖞𝖘_𝖟_瑞</span>
                <span class="author-badge">@秋天的咸鱼</span>
                <span class="author-badge">@Yoyo514</span>
                <span class="author-badge">@十七</span>
                <span class="author-badge">@Hilo(404/403)</span>
                <span class="author-badge">@快乐柠萌茶</span>
                <span class="author-badge">@三饺初华</span>
                <span class="author-badge">@银时萝</span>
                <span class="author-badge">@镜梦幻</span>
                <span class="author-badge">@风见幽泠</span>
                <span class="author-badge">@lili</span>
                <span class="author-badge">@北游</span>
                <span class="author-badge">@仰望星空</span>
            </div>
            <div class="credits-title">❖ 英灵殿 ❖</div>
            <div class="author-badges">
                <span class="author-badge">@Kitaikuyo</span>
            </div>
            <div class="credits-special"><strong>特别鸣谢：</strong>@FL已放弃治疗 @tongtny123 @willing @肆祀一一 @大乐</div>
        </div>

        <details class="info-panel">
            <summary>
                <span>汉末乱世背景与生存之道</span>
                <span class="arrow-toggle">◀</span>
            </summary>
            <div class="info-content">
                <h3>建安年间·九州板荡</h3>
                <p>
                    你是否曾畅想过，在那个礼崩乐坏却英雄辈出的年代，何为自己的归宿？是执戈卫国的忠义，是躬耕南亩的安宁，是货通天下的精明，还是悬壶济世的仁心？
                </p>

                <div class="world-quote">“天下大势，分久必合，合久必分。周末七国分争，并入于秦；秦灭之后，楚、汉分争，又并入于汉；汉朝自高祖斩白蛇而起义，一统天下，后来光武中兴，传至献帝，遂分为三国。”</div>

                <div class="world-quote">
                    “宁教我负天下人，休教天下人负我。”——曹操
                </div>

                <div class="world-quote">
                    “鞠躬尽瘁，死而后已。”——诸葛亮<br />
                    “江东子弟多才俊，卷土重来未可知。”——杜牧（咏项羽，适配江东背景）
                </div>

                <p>
                    这里是东汉末年，灵帝昏庸，黄巾蜂起，董卓乱政，群雄割据。没有魔法神迹，只有刀光剑影与人心博弈；没有层级桎梏，平民可封侯，女子可掌事。你可投效诸侯争霸天下，可归隐山林不问世事，可经商致富惠及一方，可游学四方教化世人——所有选择，皆由你定。
                </p>
                <p>不必困于“霸业”二字，只需遵从本心，在这乱世之中，走出属于自己的路。</p>

                <div class="update-section">
                    <h3>获取最新更新</h3>
                    <ul>
                        <li>
                            <a href="https://discord.com/channels/1134557553011998840/1448526819824504882" target="_blank" rel="noopener noreferrer">更新频道 *脑</a>
                        </li>
                        <li>
                            <a href="https://discord.com/channels/1291925535324110879/1448533751540879452" target="_blank" rel="noopener noreferrer">更新频道 *程</a>
                        </li>
                    </ul>
                </div>
            </div>
        </details>

        <h2 class="main-title">环境检查</h2>
        <div class="env-check-container">
            <div class="env-check-item">
                <div class="env-check-label">
                    <span class="icon">⚙️</span>
                    <span>酒馆助手</span>
                </div>
                <div class="env-check-details">
                    <span>版本: <strong id="TavernHelper-Version">加载中...</strong></span>
                    <span>状态: <strong id="TavernHelper-Status">加载中...</strong></span>
                </div>
            </div>
            <div class="env-check-item">
                <div class="env-check-label">
                    <span class="icon">📄</span>
                    <span>提示词模板 (EJS)</span>
                </div>
                <div class="env-check-details">
                    <span>状态: <strong id="ejsTemplate-Status">加载中...</strong></span>
                    <span>启用?: <strong id="ejsTemplate-Enabled">加载中...</strong></span>
                </div>
            </div>
            <div class="env-check-item">
                <div class="env-check-label">
                    <span class="icon">🧩</span>
                    <span>MVU 框架</span>
                </div>
                <div class="env-check-details">
                    <span>状态: <strong id="MVU-Status">加载中...</strong></span>
                </div>
            </div>
        </div>
        <div class="recheck-container">
            <button id="recheck-btn" class="recheck-button">重新检查</button>
            <button id="clear-cache-btn" class="clear-cache-button">刷新</button>
        </div>

        <div id="step-1" class="step-content">
            <h2 class="main-title">处世之道快捷控制</h2>
            <p id="lorebook-status">正在加载世界书信息...</p>
            <div class="control-panel-container">
                <div class="control-group">
                    <h3 class="control-group-title">核心处世之道选一（适配所有身份）:</h3>
                    <div class="control-buttons">
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="忠义守节">忠义守节</button>
                            <span class="button-desc">适配将领、文臣、义士，重气节轻生死，可托孤寄命</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="乱世枭雄">乱世枭雄</button>
                            <span class="button-desc">适配诸侯、谋士，权谋为上，审时度势，以天下为棋局</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="隐逸归田">隐逸归田</button>
                            <span class="button-desc">适配平民、隐士，避世而居，躬耕自食，不问世事纷争</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="商贾逐利">商贾逐利</button>
                            <span class="button-desc">适配行商、掌柜，货通南北，积粟囤粮，以财权影响乱世</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="医者仁心">医者仁心</button>
                            <span class="button-desc">适配郎中、药师，不分贵贱，救死扶伤，乱世行医济民</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="游侠快意">游侠快意</button>
                            <span class="button-desc">适配侠客、流民，重诺轻生死，扶危济困，浪迹九州</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="文儒治学">文儒治学</button>
                            <span class="button-desc">适配名士、夫子，著书立说，教化世人，以文脉续道统</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="destiny" data-value="无特定导向">无特定导向</button>
                            <span class="button-desc">完全自由探索，无预设行为逻辑，沙盒体验拉满</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3 class="control-group-title">三国人物互动列表（男女均适配）:</h3>
                    <div class="control-buttons">
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="结交刘备">结交刘备</button>
                            <span class="button-desc">涿县、新野等地偶遇，可随其创业或结伴逃亡</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="辅佐曹操">辅佐曹操</button>
                            <span class="button-desc">陈留、许昌等地投效，可掌兵事或任文职，展经天纬地之才</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="投奔孙权">投奔孙权</button>
                            <span class="button-desc">江东各地可遇，可守疆土或谋伐交，成江东柱石</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="师从诸葛亮">师从诸葛亮</button>
                            <span class="button-desc">隆中、成都等地可遇，习谋略兵法或奇门遁甲（史实向）</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="结识蔡文姬">结识蔡文姬</button>
                            <span class="button-desc">洛阳、邺城等地邂逅，可共研文墨或助其归汉</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="求教华佗">求教华佗</button>
                            <span class="button-desc">民间行医途中偶遇，可学医术或求治疑难杂症</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="偶遇貂蝉">偶遇貂蝉</button>
                            <span class="button-desc">洛阳、长安等地可遇，可助其完成连环计或护其脱险</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="char" data-value="结交黄月英">结交黄月英</button>
                            <span class="button-desc">襄阳、南阳等地可遇，共论经史或研习机关之术</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3 class="control-group-title">变量输出方式选一:</h3>
                    <div class="control-buttons">
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="output" data-value="主API">主API</button>
                            <span class="button-desc"></span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="output" data-value="额外API">额外API</button>
                            <span class="button-desc">切换到开局页面之后再更改MVU插件的额外模型解析设置</span>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3 class="control-group-title">史实事件链开关（多结局适配）:</h3>
                    <div class="control-buttons">
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="黄巾之乱">黄巾之乱</button>
                            <span class="button-desc">各州郡乡勇招募令触发，可平乱立功或趁机聚众</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="官渡之战">官渡之战</button>
                            <span class="button-desc">冀州、兖州等地投效袁曹势力触发，可定胜负关键</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="赤壁之战">赤壁之战</button>
                            <span class="button-desc">江夏、柴桑等地投奔孙刘或曹操触发，参与水战谋划</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="荆州风云">荆州风云</button>
                            <span class="button-desc">襄阳、江陵等地停留触发，可夺城或保境安民</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="西川攻略">西川攻略</button>
                            <span class="button-desc">益州境内探索触发，可随刘备入蜀或助刘璋守城</span>
                        </div>
                        <div class="control-item-wrapper">
                            <button class="control-button" data-group="event" data-value="洛阳之乱">洛阳之乱</button>
                            <span class="button-desc">董卓入京时期触发，可护驾、避乱或参与讨董</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="step-footer">
                <button id="next-step-btn" class="recheck-button">下一步</button>
            </div>
        </div>

        <div id="step-2" class="step-content hidden">
            <h2 class="main-title">你的汉末人生起点</h2>
            <div class="control-panel-container">
                <ul class="scenario-list">
                    <li><button class="scenario-option" data-index="1">自定义开局·我的命运我做主</button></li>
                    <li><button class="scenario-option" data-index="2">涿县起兵·讨伐黄巾初露锋芒</button></li>
                    <li><button class="scenario-option" data-index="3">江东避乱·渔樵耕读谋求生计</button></li>
                    <li><button class="scenario-option" data-index="4">荆州游学·遍访名士增长见闻</button></li>
                    <li><button class="scenario-option" data-index="5">乱世行医·游走四方救死扶伤</button></li>
                    <li><button class="scenario-option" data-index="6">西蜀经商·茶马古道积累财富</button></li>
                    <li><button class="scenario-option" data-index="7">洛阳访友·恰逢乱世被迫流亡</button></li>
                    <li><button class="scenario-option" data-index="8">边关守将·抵御匈奴保家卫国</button></li>
                </ul>
            </div>
            <div class="step-footer">
                <button id="prev-step-btn" class="recheck-button">上一步</button>
            </div>
        </div>
    </div>

    <script>
        // 适配SillyTavern环境的核心函数（保持原逻辑不变，仅适配三国背景的按钮交互）
        document.addEventListener('DOMContentLoaded', () => {
            const options = document.querySelectorAll('.scenario-option');

            async function switchSwipe(swipeId) {
                if (typeof SillyTavern === 'undefined' || !SillyTavern.chat || SillyTavern.chat.length === 0) {
                    console.warn('SillyTavern environment not detected. Action will not be executed.');
                    return;
                }

                const swipeIndex = swipeId;

                if (typeof SillyTavern.chat[0].swipe_id !== 'undefined' && SillyTavern.chat[0].swipe_id !== swipeIndex) {
                    if (SillyTavern.chat[0].swipes && SillyTavern.chat[0].swipes.length > swipeIndex) {
                        SillyTavern.chat[0].swipe_id = swipeIndex;
                        SillyTavern.chat[0].mes = SillyTavern.chat[0].swipes[swipeIndex];
                        await SillyTavern.saveChat();
                        await SillyTavern.reloadCurrentChat();
                        console.log(`Successfully switched to scenario (swipe_id: ${swipeIndex}).`);
                    } else {
                        console.error(`Swipe index ${swipeIndex} is out of bounds or swipes array is missing.`);
                    }
                } else {
                    console.log(`Scenario ${swipeIndex} is already selected or swipe data is unavailable.`);
                }
            }

            options.forEach(button => {
                button.addEventListener('click', function () {
                    const index = parseInt(this.dataset.index, 10);
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    switchSwipe(index);
                });
            });
            envcheck();
            const recheckButton = document.getElementById('recheck-btn');
            if (recheckButton) {
                recheckButton.addEventListener('click', envcheck);
            }

            const clearCacheBtn = document.getElementById('clear-cache-btn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', clearSiteCache);
            }

            function switchStep(currentId, nextId) {
                const currentStep = document.getElementById(currentId);
                const nextStep = document.getElementById(nextId);
                const container = document.querySelector('.selector-scroll');

                if (container && container.style.minHeight === '') {
                    container.style.minHeight = container.offsetHeight + 'px';
                }

                currentStep.classList.add('fade-out');

                setTimeout(() => {
                    currentStep.classList.add('hidden');
                    currentStep.classList.remove('fade-out');

                    nextStep.classList.remove('hidden');
                    nextStep.classList.add('fade-in-start');

                    void nextStep.offsetWidth;

                    nextStep.classList.remove('fade-in-start');
                }, 300);
            }

            const nextStepBtn = document.getElementById('next-step-btn');
            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', () => {
                    switchStep('step-1', 'step-2');
                });
            }

            const prevStepBtn = document.getElementById('prev-step-btn');
            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', () => {
                    switchStep('step-2', 'step-1');
                });
            }

            initializeLorebookControls();
        });

        async function clearSiteCache() {
            if (confirm('确定要刷新页面吗？')) {
                try {
                    if (window.caches) {
                        const keys = await window.caches.keys();
                        await Promise.all(keys.map(key => window.caches.delete(key)));
                    }
                    console.log('已刷新');
                } catch (e) {
                    console.error('刷新时出错:', e);
                }
                window.location.reload(true);
            }
        }

        function updateStatusElement(id, text, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerText = text;
            el.className = '';
            if (type) {
                el.classList.add('status-' + type);
            } else {
                el.classList.add('status-unknown');
            }
        }

        function envcheck() {
            let TavernHelperVersion = getTavernHelperVersion();
            let thStatusText = '未知';
            let thStatusType = 'unknown';

            if (TavernHelperVersion) {
                if (compareVersion(TavernHelperVersion, '3.4.15') != -1) {
                    thStatusText = '正常';
                    thStatusType = 'ok';
                } else {
                    thStatusText = '版本过低';
                    thStatusType = 'warn';
                }
                updateStatusElement('TavernHelper-Version', TavernHelperVersion, 'ok');
            } else {
                TavernHelperVersion = '未知';
                thStatusText = '未找到';
                thStatusType = 'error';
                updateStatusElement('TavernHelper-Version', TavernHelperVersion, 'unknown');
            }

            updateStatusElement('TavernHelper-Status', thStatusText, thStatusType);

            let ejsStatusText = '未知';
            let ejsStatusType = 'unknown';
            let ejsEnabledText = '---';
            let ejsEnabledType = 'unknown';

            try {
                const context = window.top.SillyTavern.getContext();
                const ejsTemplateSettings = context.extensionSettings.EjsTemplate;
                if (ejsTemplateSettings) {
                    ejsStatusText = '存在';
                    ejsStatusType = 'ok';
                    if (ejsTemplateSettings.enabled) {
                        ejsEnabledText = '已启用';
                        ejsEnabledType = 'ok';
                    } else {
                        ejsEnabledText = '未启用';
                        ejsEnabledType = 'warn';
                    }
                } else {
                    ejsStatusText = '未检测到';
                    ejsStatusType = 'error';
                }
            } catch (e) {
                ejsStatusText = '无法访问';
                ejsStatusType = 'error';
            }

            updateStatusElement('ejsTemplate-Status', ejsStatusText, ejsStatusType);
            updateStatusElement('ejsTemplate-Enabled', ejsEnabledText, ejsEnabledType);

            updateLockState();
            MVUcheck();
        }

        function updateLockState() {
            const idsToCheck = ['TavernHelper-Status', 'ejsTemplate-Status', 'ejsTemplate-Enabled', 'MVU-Status'];

            let allOk = true;
            for (const id of idsToCheck) {
                const el = document.getElementById(id);
                if (!el || !el.classList.contains('status-ok')) {
                    allOk = false;
                    break;
                }
            }

            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');

            if (step1) {
                if (allOk) step1.classList.remove('locked-module');
                else step1.classList.add('locked-module');
            }
            if (step2) {
                if (allOk) step2.classList.remove('locked-module');
                else step2.classList.add('locked-module');
            }
        }

        async function MVUcheck() {
            let mvuText;
            let mvuType;
            const timeoutDuration = 3000;
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('timed out'));
                    }, timeoutDuration);
                });
                await Promise.race([waitGlobalInitialized('Mvu'), timeoutPromise]);

                mvuText = '正常';
                mvuType = 'ok';
            } catch (error) {
                mvuText = '异常/超时';
                mvuType = 'error';
            }

            updateStatusElement('MVU-Status', mvuText, mvuType);
            updateLockState();
        }

        function compareVersion(v1, v2) {
            if (!v1 || !v2) return -1;
            const arr1 = v1.split('.').map(Number);
            const arr2 = v2.split('.').map(Number);
            const len = Math.max(arr1.length, arr2.length);
            for (let i = 0; i < len; i++) {
                const num1 = arr1[i] || 0;
                const num2 = arr2[i] || 0;
                if (num1 > num2) return 1;
                if (num1 < num2) return -1;
            }
            return 0;
        }

        async function initializeLorebookControls() {
            const TH = window.top.TavernHelper;
            const statusEl = document.getElementById('lorebook-status');
            const controlButtons = document.querySelectorAll('.control-button');

            if (typeof TH === 'undefined') {
                statusEl.textContent = '错误: 未找到酒馆助手插件。';
                controlButtons.forEach(btn => btn.classList.add('disabled'));
                return;
            }

            try {
                const bookInfo = TH.getCharWorldbookNames('current');
                const primaryBookName = bookInfo ? bookInfo.primary : null;

                if (!primaryBookName) {
                    statusEl.textContent = '警告: 当前角色未绑定主世界书。';
                    controlButtons.forEach(btn => btn.classList.add('disabled'));
                    return;
                }

                const entries = await TH.getWorldbook(primaryBookName);
                statusEl.textContent = `已加载主世界书: ${primaryBookName}`;

                updateButtonStates(entries);
                attachEventListeners(primaryBookName);
            } catch (error) {
                console.error('初始化世界书控件时出错:', error);
                statusEl.textContent = '错误: 加载世界书失败，请检查控制台。';
                controlButtons.forEach(btn => btn.classList.add('disabled'));
            }
        }

        function updateButtonStates(entries) {
            const destinyButtons = document.querySelectorAll('[data-group="destiny"]');
            const destinyPrefixes = {
                忠义守节: '处世之道-忠义守节核心',
                乱世枭雄: '处世之道-乱世枭雄核心',
                隐逸归田: '处世之道-隐逸归田核心',
                商贾逐利: '处世之道-商贾逐利核心',
                医者仁心: '处世之道-医者仁心核心',
                游侠快意: '处世之道-游侠快意核心',
                文儒治学: '处世之道-文儒治学核心',
                无特定导向: '处世之道-无特定导向核心',
            };
            let destinySelected = false;

            destinyButtons.forEach(btn => {
                const prefix = destinyPrefixes[btn.dataset.value];
                const isEnabled = entries.some(entry => entry.name.startsWith(prefix) && entry.enabled);
                if (isEnabled) {
                    btn.classList.add('selected');
                    destinySelected = true;
                } else {
                    btn.classList.remove('selected');
                }
            });

            const charButtons = document.querySelectorAll('[data-group="char"]');
            charButtons.forEach(btn => {
                const value = btn.dataset.value;
                let searchName = '';
                if (value === '结交刘备') searchName = '人物互动-结交刘备';
                else if (value === '辅佐曹操') searchName = '人物互动-辅佐曹操';
                else if (value === '投奔孙权') searchName = '人物互动-投奔孙权';
                else if (value === '师从诸葛亮') searchName = '人物互动-师从诸葛亮';
                else if (value === '结识蔡文姬') searchName = '人物互动-结识蔡文姬';
                else if (value === '求教华佗') searchName = '人物互动-求教华佗';
                else if (value === '偶遇貂蝉') searchName = '人物互动-偶遇貂蝉';
                else if (value === '结交黄月英') searchName = '人物互动-结交黄月英';

                if (searchName) {
                    const targetEntries = entries.filter(e => e.name.startsWith(searchName));
                    if (targetEntries && targetEntries.length > 0) {
                        const allEnabled = targetEntries.every(e => e.enabled);
                        btn.classList.toggle('toggled-on', allEnabled);
                    }
                }
            });

            const outputButtons = document.querySelectorAll('[data-group="output"]');
            const outputNames = {
                主API: 'output_format (随AI输出开，主API)',
                额外API: '[mvu_update]output_format (使用额外模型更新变量开)',
            };
            let outputSelected = false;
            outputButtons.forEach(btn => {
                const fullName = outputNames[btn.dataset.value];
                const isEnabled = entries.some(entry => entry.name === fullName && entry.enabled);
                if (isEnabled) {
                    btn.classList.add('selected');
                    outputSelected = true;
                } else {
                    btn.classList.remove('selected');
                }
            });

            const eventButtons = document.querySelectorAll('[data-group="event"]');
            eventButtons.forEach(btn => {
                const value = btn.dataset.value;
                let targetEntries;
                if (value === '黄巾之乱') {
                    targetEntries = entries.filter(e => e.name.startsWith('【黄巾之乱】'));
                } else if (value === '官渡之战') {
                    targetEntries = entries.filter(e => e.name.startsWith('【官渡之战】'));
                } else if (value === '赤壁之战') {
                    targetEntries = entries.filter(e => e.name.startsWith('【赤壁之战】'));
                } else if (value === '荆州风云') {
                    targetEntries = entries.filter(e => e.name.startsWith('【荆州风云】'));
                } else if (value === '西川攻略') {
                    targetEntries = entries.filter(e => e.name.startsWith('【西川攻略】'));
                } else if (value === '洛阳之乱') {
                    targetEntries = entries.filter(e => e.name.startsWith('【洛阳之乱】'));
                }

                if (targetEntries && targetEntries.length > 0) {
                    const allEnabled = targetEntries.every(e => e.enabled);
                    btn.classList.toggle('toggled-on', allEnabled);
                }
            });
        }

        function attachEventListeners(bookName) {
            const controlButtons = document.querySelectorAll('.control-button');
            controlButtons.forEach(button => {
                button.replaceWith(button.cloneNode(true));
            });
            document.querySelectorAll('.control-button').forEach(button => {
                if (!button.classList.contains('disabled')) {
                    button.addEventListener('click', () =>
                        handleButtonClick(button.dataset.group, button.dataset.value, bookName),
                    );
                }
            });
        }

        async function handleButtonClick(group, value, bookName) {
            const TH = window.top.TavernHelper;

            try {
                await TH.updateWorldbookWith(bookName, entries => {
                    if (group === 'destiny') {
                        const prefixes = {
                            忠义守节: '处世之道-忠义守节核心',
                            乱世枭雄: '处世之道-乱世枭雄核心',
                            隐逸归田: '处世之道-隐逸归田核心',
                            商贾逐利: '处世之道-商贾逐利核心',
                            医者仁心: '处世之道-医者仁心核心',
                            游侠快意: '处世之道-游侠快意核心',
                            文儒治学: '处世之道-文儒治学核心',
                            无特定导向: '处世之道-无特定导向核心',
                        };
                        const targetPrefix = prefixes[value];
                        entries.forEach(entry => {
                            if (entry.name.startsWith(targetPrefix)) {
                                entry.enabled = true;
                            } else if (Object.values(prefixes).some(p => entry.name.startsWith(p))) {
                                entry.enabled = false;
                            }
                        });

                    } else if (group === 'char') {
                        let searchName = '';
                        if (value === '结交刘备') searchName = '人物互动-结交刘备';
                        else if (value === '辅佐曹操') searchName = '人物互动-辅佐曹操';
                        else if (value === '投奔孙权') searchName = '人物互动-投奔孙权';
                        else if (value === '师从诸葛亮') searchName = '人物互动-师从诸葛亮';
                        else if (value === '结识蔡文姬') searchName = '人物互动-结识蔡文姬';
                        else if (value === '求教华佗') searchName = '人物互动-求教华佗';
                        else if (value === '偶遇貂蝉') searchName = '人物互动-偶遇貂蝉';
                        else if (value === '结交黄月英') searchName = '人物互动-结交黄月英';

                        const targetEntries = entries.filter(e => e.name.startsWith(searchName));

                        if (targetEntries && targetEntries.length > 0) {
                            const shouldEnable = targetEntries.some(e => !e.enabled);
                            const targetNames = targetEntries.map(e => e.name);
                            entries.forEach(entry => {
                                if (targetNames.includes(entry.name)) {
                                    entry.enabled = shouldEnable;
                                }
                            });
                        }
                    } else if (group === 'output') {
                        const names = {
                            主API: 'output_format (随AI输出开，主API)',
                            额外API: '[mvu_update]output_format (使用额外模型更新变量开)',
                        };
                        const targetName = names[value];
                        entries.forEach(entry => {
                            if (entry.name === targetName) {
                                entry.enabled = true;
                            } else if (Object.values(names).includes(entry.name)) {
                                entry.enabled = false;
                            }
                        });
                    } else if (group === 'event') {
                        let targetEntries;
                        if (value === '黄巾之乱') {
                            targetEntries = entries.filter(e => e.name.startsWith('【黄巾之乱】'));
                        } else if (value === '官渡之战') {
                            targetEntries = entries.filter(e => e.name.startsWith('【官渡之战】'));
                        } else if (value === '赤壁之战') {
                            targetEntries = entries.filter(e => e.name.startsWith('【赤壁之战】'));
                        } else if (value === '荆州风云') {
                            targetEntries = entries.filter(e => e.name.startsWith('【荆州风云】'));
                        } else if (value === '西川攻略') {
                            targetEntries = entries.filter(e => e.name.startsWith('【西川攻略】'));
                        } else if (value === '洛阳之乱') {
                            targetEntries = entries.filter(e => e.name.startsWith('【洛阳之乱】'));
                        }

                        if (targetEntries && targetEntries.length > 0) {
                            const shouldEnable = targetEntries.some(e => !e.enabled);
                            const targetNames = targetEntries.map(e => e.name);
                            entries.forEach(entry => {
                                if (targetNames.includes(entry.name)) {
                                    entry.enabled = shouldEnable;
                                }
                            });
                        }
                    }
                    return entries;
                });
            } catch (error) {
                console.error('更新世界书失败:', error);
                document.getElementById('lorebook-status').textContent = '错误: 更新世界书失败!';
            } finally {
                await initializeLorebookControls();
            }
        }

        // 补全缺失的依赖函数（确保网页独立运行）
        function getTavernHelperVersion() {
            if (window.top.TavernHelper && window.top.TavernHelper.version) {
                return window.top.TavernHelper.version;
            }
            return null;
        }

        function waitGlobalInitialized(globalName) {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window[globalName]) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>
